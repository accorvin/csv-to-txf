# CSV to TXF Converter - Functional Requirements

A CLI tool to convert Monarch Money CSV transaction exports into TXF (Tax Exchange Format) files for importing charitable contribution data into TurboTax Desktop.

## 1. Overview

### 1.1 Purpose
Convert CSV files containing charitable donation transactions exported from Monarch Money into TXF format compatible with TurboTax Desktop 2026 for Schedule A itemized deductions.

### 1.2 Scope
- **In Scope**: Cash and check donations only
- **Out of Scope**: Non-cash donations, securities, property donations, QCDs, carryover contributions

### 1.3 Target User
Personal tax preparation by an individual end user.

---

## 2. Input Requirements

### 2.1 CSV File Format (Monarch Money Export)

The tool shall accept CSV files with the following columns in this exact order:

| Column | Position | Required | Description |
|--------|----------|----------|-------------|
| Date | 1 | Yes | Transaction date |
| Merchant | 2 | Yes | Name of the charitable organization |
| Category | 3 | No | Transaction category (can be used for filtering) |
| Account | 4 | No | Source account |
| Original Statement | 5 | No | Original bank statement description (ignored) |
| Notes | 6 | No | Additional notes |
| Amount | 7 | Yes | Donation amount (negative value in Monarch format) |
| Tags | 8 | No | Transaction tags |
| Owner | 9 | No | Account owner (ignored) |

### 2.2 File Requirements
- FR-IN-001: The tool shall accept a single CSV file path as input
- FR-IN-002: The tool shall support UTF-8 encoded CSV files
- FR-IN-003: The tool shall accept CSV files with headers in the first row
- FR-IN-004: The tool shall handle quoted fields containing commas

---

## 3. Configuration File Requirements

### 3.1 Purpose

The configuration file maps Merchant names from Monarch Money to official charitable organization names and optional EIN values, eliminating the need to manually edit CSV files.

### 3.2 File Format

The configuration file shall be in YAML format.

#### 3.2.1 Structure

```yaml
# Merchant mappings configuration
mappings:
  - merchant: "UNITED WAY"
    organization: "United Way Worldwide"
    ein: "13-1635294"

  - merchant: "RED CROSS"
    organization: "American National Red Cross"
    ein: "53-0196605"

  - merchant: "GOODWILL DONATION"
    organization: "Goodwill Industries International"
    # ein is optional

  # Multiple merchants can map to the same organization
  - merchant: "HABITAT RESTORE"
    organization: "Habitat for Humanity International"
    ein: "91-1914868"

  - merchant: "HABITAT FOR HUMANITY"
    organization: "Habitat for Humanity International"
    ein: "91-1914868"
```

#### 3.2.2 Field Definitions

| Field | Required | Description |
|-------|----------|-------------|
| merchant | Yes | Merchant name from Monarch CSV (matched case-insensitively) |
| organization | Yes | Official charity name for TXF output |
| ein | No | Employer Identification Number (format: XX-XXXXXXX) |

### 3.3 Configuration File Location

- FR-CFG-001: The tool shall accept a config file path via `--config` CLI flag
- FR-CFG-002: If no `--config` flag is provided, the tool shall look for a config file at `~/.config/csv-to-txf/mappings.yaml`
- FR-CFG-003: If no config file is found in either location, the tool shall exit with an error

### 3.4 Merchant Matching

- FR-CFG-004: Merchant matching shall be case-insensitive
- FR-CFG-005: Merchant matching shall require an exact match (after case normalization)
- FR-CFG-006: If multiple mappings exist for the same merchant (case-insensitive), the tool shall use the first match and warn

### 3.5 Config Initialization Command

The tool shall provide a subcommand to generate an initial configuration file from a CSV.

#### 3.5.1 Command Syntax
```
csv-to-txf init <input.csv> [options]
```

#### 3.5.2 Behavior
- FR-CFG-007: The `init` command shall extract all unique merchant names from the CSV
- FR-CFG-008: The `init` command shall generate a YAML file with merchant entries, leaving `organization` fields blank for user completion
- FR-CFG-009: The `init` command shall output to stdout by default, or to a file if `-o` is specified
- FR-CFG-010: The `init` command shall sort merchants alphabetically
- FR-CFG-011: If a config file already exists, the `init` command shall merge new merchants (preserving existing mappings) when `--merge` flag is used

#### 3.5.3 Example Output
```yaml
# Generated by csv-to-txf init
# Fill in the 'organization' field for each merchant
mappings:
  - merchant: "GOODWILL DONATION"
    organization: ""  # TODO: Fill in official organization name
    # ein: ""  # Optional: Add EIN

  - merchant: "RED CROSS"
    organization: ""  # TODO: Fill in official organization name
    # ein: ""  # Optional: Add EIN
```

---

## 4. Output Requirements

### 4.1 TXF File Format

The tool shall generate TXF files conforming to TXF Specification v042.

#### 4.1.1 Header Format
```
V042
A<application-name-and-version>
D<export-date>
```

#### 4.1.2 Charitable Contribution Record Format
```
TD
N280
C1
L1
$<negative-amount>
X<date> <account> <payee-info>
^
```

Where:
- `TD` = Detail record type
- `N280` = Refnum for "Cash charity contributions" (Schedule A)
- `C1` = Copy number
- `L1` = Line number
- `$` = Amount (must be negative for expenses)
- `X` = Detail line containing date, account, and organization name
- `^` = Record terminator

### 4.2 Output File Requirements
- FR-OUT-001: The tool shall write the TXF file to a user-specified output path
- FR-OUT-002: If no output path is specified, the tool shall write to the same directory as the input file with a `.txf` extension
- FR-OUT-003: The tool shall use ASCII encoding for the TXF file
- FR-OUT-004: The tool shall use CRLF line endings for maximum compatibility

---

## 5. Data Transformation Requirements

### 5.1 Amount Handling
- FR-TRANS-001: The tool shall convert positive amounts to negative (TXF requires expenses as negative)
- FR-TRANS-002: The tool shall preserve negative amounts as-is (Monarch exports expenses as negative)
- FR-TRANS-003: The tool shall format amounts with exactly 2 decimal places

### 5.2 Date Handling
- FR-TRANS-004: The tool shall parse dates in common formats (MM/DD/YYYY, YYYY-MM-DD, M/D/YYYY)
- FR-TRANS-005: The tool shall output dates in MM/DD/YYYY format for TXF

### 5.3 Organization Name Lookup
- FR-TRANS-006: The tool shall look up the Merchant value in the configuration file to obtain the organization name
- FR-TRANS-007: The tool shall use the `organization` value from the matching config entry for TXF output
- FR-TRANS-008: The tool shall truncate organization names exceeding 64 characters
- FR-TRANS-009: If an EIN is present in the config entry, the tool shall include it in the TXF detail line

---

## 6. Validation Requirements

### 6.1 Preflight Validation

Before processing any transactions, the tool shall perform preflight checks to fail fast.

#### 6.1.1 Configuration Validation
- FR-VAL-001: The tool shall validate that a configuration file exists and is valid YAML
- FR-VAL-002: The tool shall validate that all config entries have non-empty `merchant` and `organization` values
- FR-VAL-003: The tool shall warn if config entries have duplicate merchant names (case-insensitive)

#### 6.1.2 Merchant Mapping Validation
- FR-VAL-004: The tool shall extract all unique Merchant values from the CSV before processing
- FR-VAL-005: The tool shall verify that every Merchant has a corresponding mapping in the config file
- FR-VAL-006: If any Merchant is missing a mapping, the tool shall list all unmapped merchants and exit with an error
- FR-VAL-007: The tool shall not produce any output if preflight validation fails

### 6.2 Required Field Validation
- FR-VAL-008: The tool shall reject rows missing a Date value
- FR-VAL-009: The tool shall reject rows missing an Amount value
- FR-VAL-010: The tool shall reject rows missing a Merchant value
- FR-VAL-011: The tool shall report all validation errors with line numbers

### 6.3 Date Validation
- FR-VAL-012: The tool shall validate that all dates fall within the specified tax year
- FR-VAL-013: The tool shall accept a `--tax-year` argument (default: 2026)
- FR-VAL-014: The tool shall warn (not error) if dates fall outside the tax year

### 6.4 Amount Validation
- FR-VAL-015: The tool shall reject rows with non-numeric amounts
- FR-VAL-016: The tool shall reject rows with zero amounts
- FR-VAL-017: The tool shall warn if any single donation exceeds $250 (receipt requirement threshold)

### 6.5 Duplicate Detection
- FR-VAL-018: The tool shall warn if duplicate entries are detected (same date, amount, and organization)
- FR-VAL-019: The tool shall still include duplicates in output (user decides to remove)

---

## 7. CLI Interface Requirements

### 7.1 Command Syntax

#### 7.1.1 Convert Command (default)
```
csv-to-txf <input.csv> [options]
csv-to-txf convert <input.csv> [options]
```

#### 7.1.2 Init Command
```
csv-to-txf init <input.csv> [options]
```

### 7.2 Required Arguments
- FR-CLI-001: The tool shall accept a positional argument for the input CSV file path

### 7.3 Optional Arguments

#### 7.3.1 Convert Command Options
| Flag | Description | Default |
|------|-------------|---------|
| `-c, --config` | Path to merchant mappings YAML file | `~/.config/csv-to-txf/mappings.yaml` |
| `-o, --output` | Output TXF file path | `<input-basename>.txf` |
| `--tax-year` | Tax year for date validation | 2026 |
| `--category` | Filter by category value | None (include all) |
| `--dry-run` | Validate without writing output | false |
| `-v, --verbose` | Show detailed processing info | false |
| `-q, --quiet` | Suppress warnings, show errors only | false |

#### 7.3.2 Init Command Options
| Flag | Description | Default |
|------|-------------|---------|
| `-o, --output` | Output YAML file path | stdout |
| `--merge` | Merge with existing config file | false |

### 7.4 Exit Codes
- FR-CLI-002: Exit code 0 for success
- FR-CLI-003: Exit code 1 for validation errors (no output written)
- FR-CLI-004: Exit code 2 for file I/O errors
- FR-CLI-005: Exit code 3 for missing merchant mappings

---

## 8. Reporting Requirements

### 8.1 Summary Report
- FR-RPT-001: The tool shall display a summary after processing:
  - Total transactions processed
  - Total donation amount
  - Number of unique organizations
  - Number of warnings

### 8.2 Verbose Output
- FR-RPT-002: In verbose mode, the tool shall list each transaction processed
- FR-RPT-003: In verbose mode, the tool shall show the generated TXF content

---

## 9. Error Handling Requirements

- FR-ERR-001: The tool shall display clear, actionable error messages
- FR-ERR-002: The tool shall not write partial output on validation failure
- FR-ERR-003: The tool shall gracefully handle file permission errors
- FR-ERR-004: The tool shall handle empty CSV files with an appropriate message

---

## 10. Non-Functional Requirements

### 10.1 Compatibility
- NFR-001: TXF output shall be compatible with TurboTax Desktop 2026
- NFR-002: The tool shall run on macOS (darwin)

### 10.2 Performance
- NFR-003: The tool shall process files with up to 1,000 transactions without noticeable delay

---

## 11. Future Considerations (Out of Scope for v1)

The following features are explicitly out of scope but may be considered for future versions:
- Non-cash charitable contributions (would require Form 8283 support)
- EIN validation against IRS database
- AGI-based contribution limit calculations
- Multi-year carryover tracking
- TurboTax Online support (does not support TXF import)

---

## Appendix A: TXF Reference

### A.1 Relevant TXF Reference Numbers

| Refnum | Description | Schedule/Line |
|--------|-------------|---------------|
| 280 | Cash charity contributions | Schedule A |
| 485 | Non-cash charity contributions | Schedule A (out of scope) |

### A.2 TXF Specification Source
- [TXF Specification v042](https://taxdataexchange.org/docs/txf/v042/txf-spec.html)
- [TXF Reference Numbers by Form](https://taxdataexchange.org/docs/txf/v042/reference-numbers-by-form.html)

---

## Appendix B: Monarch Money CSV Preparation

### B.1 Exporting from Monarch
1. Navigate to Settings > Data
2. Select "Download Transactions"
3. Choose date range covering tax year 2026

### B.2 Monarch Export Format

The exported CSV contains these columns in order:
```
Date,Merchant,Category,Account,Original Statement,Notes,Amount,Tags,Owner
```

### B.3 Recommended Workflow

#### First-Time Setup
1. Export all transactions from Monarch
2. Filter to charitable donations only (by Category or manually)
3. Run `csv-to-txf init donations.csv -o ~/.config/csv-to-txf/mappings.yaml`
4. Edit the generated YAML to fill in official organization names and EINs

#### Annual Tax Preparation
1. Export transactions from Monarch for the tax year
2. Filter to charitable donations only
3. Run `csv-to-txf init donations.csv --merge` to add any new merchants
4. Fill in organization names for any new merchants
5. Run `csv-to-txf donations.csv -o donations.txf`
6. Import the TXF file into TurboTax Desktop

### B.4 Reference
- [Monarch Money: Downloading Transaction History](https://help.monarch.com/hc/en-us/articles/15526600975764-Downloading-Transaction-or-Account-History)
